<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFE SOLUTION</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        body {
            font-family: 'Inter', sans-serif;
            cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='white' d='M2.93 12.04l8.3-8.3a1 1 0 011.41 0l8.3 8.3a1 1 0 010 1.41l-8.3 8.3a1 1 0 01-1.41 0l-8.3-8.3a1 1 0 010-1.41z'/%3E%3Cpath fill='black' stroke='white' stroke-width='1.5' d='M2.93 12.04l8.3-8.3a1 1 0 011.41 0l8.3 8.3a1 1 0 010 1.41l-8.3 8.3a1 1 0 01-1.41 0l-8.3-8.3a1 1 0 010-1.41z'/%3E%3C/svg%3E") 12 12, auto;
            background: linear-gradient(135deg, #e0e7f9, #d0e0ff);
            color: #1a202c;
        }

        .chat-bubble-self {
            position: relative;
            background-color: #4c51bf;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem 0.5rem 1.5rem 1.5rem;
        }
        .chat-bubble-self::before {
            content: '';
            position: absolute;
            top: 0;
            right: -0.5rem;
            width: 1rem;
            height: 1rem;
            background-color: transparent;
            border-bottom-left-radius: 1rem;
            box-shadow: 0 0.5rem 0 0 #4c51bf;
        }

        .chat-bubble-other {
            position: relative;
            background-color: #e2e8f0;
            color: #2d3748;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem 1.5rem 1.5rem 1.5rem;
        }
        .chat-bubble-other::before {
            content: '';
            position: absolute;
            top: 0;
            left: -0.5rem;
            width: 1rem;
            height: 1rem;
            background-color: transparent;
            border-bottom-right-radius: 1rem;
            box-shadow: 0.5rem 0.5rem 0 0 #e2e8f0;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        .animate-slide-up {
            animation: slideUp 0.5s ease-in-out;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main App Container -->
    <div id="app" class="bg-white rounded-[32px] shadow-2xl p-6 md:p-8 w-full max-w-2xl h-[calc(100vh-2rem)] flex flex-col transition-all duration-500 ease-in-out animate-fade-in">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, updateDoc, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Check for required environment variables and use placeholders if they don't exist.
        // This allows the app to run locally on your PC.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "your-api-key",
            authDomain: "your-project-id.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project-id.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug');

        let allComments = [];

        // Simple state management for the app
        let currentPage = 'quotes';

        // Quotes for the first page
        const quotes = [
            "The journey of a thousand miles begins with a single step.",
            "The only way to do great work is to love what you do.",
            "Believe you can and you're halfway there.",
            "What you get by achieving your goals is not as important as what you become by achieving your goals.",
            "The future belongs to those who believe in the beauty of their dreams."
        ];

        // Function to render a page
        function renderPage() {
            const appDiv = document.getElementById('app');
            appDiv.innerHTML = ''; // Clear previous content

            if (currentPage === 'quotes') {
                renderQuotesPage(appDiv);
            } else if (currentPage === 'comments') {
                renderCommentsPage(appDiv);
                renderNavbar(appDiv);
            } else if (currentPage === 'chat') {
                renderChatPage(appDiv);
                renderNavbar(appDiv);
            }
        }

        // Function to render the quotes page
        function renderQuotesPage(container) {
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            const quoteHTML = `
                <div class="flex-grow flex flex-col items-center justify-center p-8 text-center">
                    <div class="p-8 rounded-[32px] shadow-lg bg-gray-50 max-w-lg w-full">
                        <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4">
                            Make anything possible,<br>in LIFE SOLUTION
                        </h1>
                        <p class="text-lg md:text-xl font-medium text-gray-600 mb-8 max-w-md mx-auto">
                            "${randomQuote}"
                        </p>
                        <button id="nextBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                            Get started
                        </button>
                    </div>
                </div>
            `;
            container.innerHTML = quoteHTML;
            document.getElementById('nextBtn').addEventListener('click', () => {
                currentPage = 'comments';
                renderPage();
            });
        }

        // Function to render the comments page
        function renderCommentsPage(container) {
            const commentsHTML = `
                <div class="flex-grow flex flex-col h-full overflow-hidden">
                    <h2 class="text-3xl font-bold mb-4 text-center">Community Stories</h2>
                    <p class="text-gray-500 mb-4 text-center">Share your experience or read others' stories to find inspiration.</p>
                    <div id="commentsList" class="flex-grow overflow-y-auto space-y-6 p-4 bg-gray-50 rounded-[16px] shadow-inner mb-4">
                        <!-- Comments will be injected here -->
                    </div>
                    <form id="commentForm" class="flex items-center space-x-2 p-2">
                        <input type="text" id="commentInput" placeholder="Add your life experience here..." required class="flex-grow p-4 rounded-full border border-gray-300 focus:outline-none focus:border-blue-500 shadow-md">
                        <button type="submit" class="bg-blue-600 text-white p-4 rounded-full hover:bg-blue-700 transition duration-300 transform hover:scale-110 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </form>
                </div>
            `;
            container.innerHTML = commentsHTML;

            document.getElementById('commentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('commentInput');
                const commentText = input.value.trim();
                if (commentText) {
                    try {
                        const path = `/artifacts/${appId}/public/data/comments`;
                        await addDoc(collection(db, path), {
                            content: commentText,
                            createdAt: new Date()
                        });
                        input.value = '';
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                }
            });

            // Listen for comments in real time
            const commentsPath = `/artifacts/${appId}/public/data/comments`;
            const q = query(collection(db, commentsPath));
            onSnapshot(q, (snapshot) => {
                allComments = [];
                snapshot.forEach((doc) => {
                    allComments.push({ id: doc.id, content: doc.data().content });
                });
                renderComments();
            }, (error) => {
                console.error("Error fetching comments: ", error);
            });
        }

        // Function to shuffle comments and display them
        function renderComments() {
            const commentsList = document.getElementById('commentsList');
            if (!commentsList) return;

            // Shuffle comments for a random display
            const shuffledComments = [...allComments].sort(() => 0.5 - Math.random());
            commentsList.innerHTML = shuffledComments.map(comment => `
                <div class="bg-white p-6 rounded-[16px] shadow-lg text-gray-800 flex flex-col space-y-4 animate-slide-up">
                    <img src="https://placehold.co/400x200/c7d2fe/3730a3?text=Community+Story" alt="Placeholder image for a user story" class="rounded-lg mb-4 object-cover w-full h-48">
                    <p class="flex-grow text-lg italic leading-relaxed">"${comment.content}"</p>
                    <div class="flex space-x-2 self-end">
                        <button class="edit-btn text-blue-600 hover:text-blue-800 transition duration-200" data-doc-id="${comment.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-7.228 7.228a2 2 0 01-1.414.586H4a1 1 0 01-1-1v-2.12a2 2 0 01.586-1.414l7.228-7.228zM15 5l-1.5-1.5L9 8.5V10h1.5l4.5-4.5z" />
                            </svg>
                        </button>
                        <button class="delete-btn text-red-600 hover:text-red-800 transition duration-200" data-doc-id="${comment.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-1 1v1H5a1 1 0 000 2h14a1 1 0 100-2h-3V3a1 1 0 00-1-1H9zM7 7H5v12a2 2 0 002 2h6a2 2 0 002-2V7h-2v11a1 1 0 11-2 0V7H7zm2 0h2v11a1 1 0 11-2 0V7z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            commentsList.scrollTop = commentsList.scrollHeight; // Scroll to bottom

            // Add event listeners for new buttons
            commentsList.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.docId;
                    const oldContent = allComments.find(c => c.id === docId)?.content;
                    const newContent = prompt("Edit your story:", oldContent);
                    if (newContent !== null && newContent.trim() !== '') {
                        try {
                            const docRef = doc(db, `/artifacts/${appId}/public/data/comments`, docId);
                            await updateDoc(docRef, {
                                content: newContent
                            });
                        } catch (e) {
                            console.error("Error updating document: ", e);
                        }
                    }
                });
            });

            commentsList.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const docId = e.currentTarget.dataset.docId;
                    try {
                        const docRef = doc(db, `/artifacts/${appId}/public/data/comments`, docId);
                        await deleteDoc(docRef);
                    } catch (e) {
                        console.error("Error deleting document: ", e);
                    }
                });
            });
        }

        // Function to render the chat page
        function renderChatPage(container) {
            const chatHTML = `
                <div class="flex-grow flex flex-col h-full">
                    <h2 class="text-3xl font-bold mb-4 text-center">Solution Chat</h2>
                    <p class="text-gray-500 mb-4 text-center">Get anonymous advice based on shared experiences.</p>
                    <div id="messages" class="flex-grow overflow-y-auto p-4 space-y-4 rounded-[16px] bg-gray-100 shadow-inner">
                        <!-- Chat messages will be injected here -->
                    </div>
                    <form id="chatForm" class="flex items-center space-x-2 p-2 bg-white rounded-full shadow-md mt-4">
                        <input type="text" id="chatInput" placeholder="What's on your mind?..." required class="flex-grow p-4 bg-transparent focus:outline-none">
                        <button type="submit" class="bg-blue-600 text-white p-4 rounded-full hover:bg-blue-700 transition duration-300 transform hover:scale-110 shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </form>
                </div>
            `;
            container.innerHTML = chatHTML;

            const messagesDiv = document.getElementById('messages');
            const chatInput = document.getElementById('chatInput');

            document.getElementById('chatForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userQuery = chatInput.value.trim();
                if (userQuery) {
                    addMessage(userQuery, 'self');
                    chatInput.value = '';
                    addMessage('Thinking...', 'other');
                    await provideSolution(userQuery);
                }
            });

            function addMessage(text, type) {
                const messageBubble = document.createElement('div');
                const bubbleClass = type === 'self' ? 'chat-bubble-self ml-auto' : 'chat-bubble-other mr-auto';
                messageBubble.className = `flex ${type === 'self' ? 'justify-end' : 'justify-start'}`;
                messageBubble.innerHTML = `<div class="max-w-xs md:max-w-md break-words ${bubbleClass}">${text}</div>`;
                messagesDiv.appendChild(messageBubble);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            async function provideSolution(query) {
                const loadingMessage = messagesDiv.lastChild;
                const path = `/artifacts/${appId}/public/data/comments`;

                // Use a different query to fetch all comments for Gemini
                const allCommentsQuery = query(collection(db, path));
                const commentsSnapshot = await getDocs(allCommentsQuery);
                const allComments = commentsSnapshot.docs.map(doc => doc.data().content);

                const commentsString = allComments.join('\n\n');

                const systemPrompt = "You are a helpful life solution assistant. Based on the user's query and the provided community stories, generate a concise, empathetic, and relevant response. Only use the information provided in the stories. If you cannot find a relevant solution, state that you do not have an answer in the stories and suggest the user add their own story.";
                const userQueryWithContext = `User's question: "${query}"\n\nCommunity stories:\n${commentsString}`;

                const payload = {
                    contents: [{
                        parts: [{ text: userQueryWithContext }]
                    }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    messagesDiv.removeChild(loadingMessage); // Remove loading message
                    addMessage(text || "Error generating response.", 'other');
                } catch (e) {
                    messagesDiv.removeChild(loadingMessage); // Remove loading message
                    addMessage("I'm sorry, an error occurred while finding a solution. Please try again.", 'other');
                    console.error("API call failed:", e);
                }
            }
        }
        
        // Function to render the common navigation bar
        function renderNavbar(container) {
            const navbarHTML = `
                <div class="mt-4 flex justify-around items-center p-3 bg-white rounded-full shadow-lg">
                    <button id="storiesNavBtn" class="flex-1 flex flex-col items-center justify-center p-2 rounded-full transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-blue-600 transition duration-300" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 3a1 1 0 011 1v12a1 1 0 01-1 1h-1.5a.5.5 0 00-.5.5v1.5a.5.5 0 00.5.5h3a.5.5 0 00.5-.5v-1.5a.5.5 0 00-.5-.5H12a1 1 0 01-1-1V4a1 1 0 011-1h1.5a.5.5 0 00.5.5v1.5a.5.5 0 00-.5.5H12a1 1 0 01-1 1z" />
                            <path d="M12 16a2 2 0 100-4 2 2 0 000 4z" />
                        </svg>
                        <span class="text-xs mt-1 font-semibold text-gray-500">Stories</span>
                    </button>
                    <button id="chatNavBtn" class="flex-1 flex flex-col items-center justify-center p-2 rounded-full transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 group-hover:text-emerald-600 transition duration-300" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 21a9 9 0 100-18 9 9 0 000 18z" />
                            <path d="M12 14.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5V16a.5.5 0 00.5.5h2a.5.5 0 00.5-.5v-1.5z" />
                        </svg>
                        <span class="text-xs mt-1 font-semibold text-gray-500">Chat</span>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', navbarHTML);

            document.getElementById('storiesNavBtn').addEventListener('click', () => {
                currentPage = 'comments';
                renderPage();
            });

            document.getElementById('chatNavBtn').addEventListener('click', () => {
                currentPage = 'chat';
                renderPage();
            });
        }

        // Initialize the app on load
        window.onload = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase auth error:", error);
            }
            renderPage();
        };

    </script>
</body>
</html>
